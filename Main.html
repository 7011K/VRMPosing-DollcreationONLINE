<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VRMPosing+DollcreationONLINE</title>
    <meta
      name="description"
      content="VRMPosing+DollcreationONLINEはブラウザ上でVRMアバターのポーズ編集や、背景透過画像の撮影やポーズさせたVRMファイルのフィギュア化がお手軽に出来るWebアプリケーションです。"
    />
    <script type="module" crossorigin src="assets/index-5e29ee16.js"></script>
    <link rel="stylesheet" href="assets/mainindex.css">
    <link rel="manifest" href="manifest.webmanifest">
  </head>
  <body>
    <div id="root"></div>
    <script>
      // myapp_tokenがなければIndex.htmlにリダイレクト
      if (!sessionStorage.getItem("myapp_token")) {
        window.location.href = "index.html";
      }
    </script>
    <script type="module">
      // --- アドオン自動ローダ ---
      // 「./addons/addons-list.json」から全*.jsを取得し、自動でimport

      async function discoverAddonJsFiles() {
        try {
          const resp = await fetch("./addons/addons-list.json");
          if (!resp.ok) throw new Error("アドオン一覧の取得に失敗しました");
          return await resp.json(); // 例: ["addons/xxx/xxx.js", ...]
        } catch (e) {
          console.error("アドオン一覧取得エラー", e);
          return [];
        }
      }

      async function loadAndInitAddons({ threeRenderer, mountPoint }) {
        const addonFiles = await discoverAddonJsFiles();
        for (const addonPath of addonFiles) {
          const baseUrl = addonPath.substring(0, addonPath.lastIndexOf('/') + 1);
          try {
            await import(`./${addonPath}`);
            if (window.MyAppAddons) {
              window.MyAppAddons.forEach(fn => {
                try {
                  fn({ threeRenderer, mountPoint, addonBaseUrl: baseUrl });
                } catch (e) {
                  console.error(`[ADDON ERROR]`, addonPath, e);
                }
              });
            }
          } catch (e) {
            console.error(`Failed to load addon: ${addonPath}`, e);
          }
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        // Three.js renderer取得方法をdQクラス構成に合わせて取得
        const threeRenderer =
          (window.UQ && window.UQ._viewer && window.UQ._viewer.renderer)
          || null;

        const canvas = document.querySelector("canvas");
        const mountPoint = canvas ? canvas.parentNode : document.getElementById("root");
        console.log("Three.js renderer:", threeRenderer);
        loadAndInitAddons({ threeRenderer, mountPoint });
      });
    </script>
  </body>
</html>

